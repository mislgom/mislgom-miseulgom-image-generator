<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ê´€ë¦¬ì - ë¯¸ìŠ¬ê³° ì´ë¯¸ì§€ ìƒì„±ê¸°</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="styles/main.css">
    <style>
        .admin-container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 40px 20px;
        }

        .admin-header {
            margin-bottom: 40px;
        }

        .admin-title {
            font-size: 32px;
            font-weight: 700;
            color: var(--text-primary);
            margin-bottom: 8px;
        }

        .admin-subtitle {
            font-size: 16px;
            color: var(--text-secondary);
        }

        .admin-section {
            background: var(--bg-primary);
            border: 1px solid var(--border-color);
            border-radius: 12px;
            padding: 32px;
            margin-bottom: 32px;
        }

        .section-title {
            font-size: 20px;
            font-weight: 600;
            color: var(--text-primary);
            margin-bottom: 24px;
        }

        .create-user-form {
            display: grid;
            grid-template-columns: 1fr 1fr 1fr auto;
            gap: 12px;
            margin-bottom: 32px;
        }

        .users-table {
            width: 100%;
            border-collapse: collapse;
        }

        .users-table th {
            text-align: left;
            padding: 12px 16px;
            background: var(--bg-secondary);
            border-bottom: 2px solid var(--border-color);
            font-weight: 600;
            color: var(--text-primary);
        }

        .users-table td {
            padding: 12px 16px;
            border-bottom: 1px solid var(--border-color);
            color: var(--text-primary);
        }

        .users-table tbody tr:hover {
            background: var(--bg-secondary);
        }

        .badge {
            display: inline-block;
            padding: 4px 12px;
            border-radius: 12px;
            font-size: 12px;
            font-weight: 600;
        }

        .badge-admin {
            background: #fef3c7;
            color: #92400e;
        }

        .badge-user {
            background: #dbeafe;
            color: #1e40af;
        }

        .btn-delete {
            padding: 6px 12px;
            font-size: 13px;
            background: #fee2e2;
            color: #991b1b;
            border: none;
            border-radius: 6px;
            cursor: pointer;
        }

        .btn-delete:hover {
            background: #fecaca;
        }

        .logout-btn {
            position: fixed;
            top: 20px;
            right: 20px;
        }

        .empty-state {
            text-align: center;
            padding: 48px 20px;
            color: var(--text-secondary);
        }

        .loading {
            text-align: center;
            padding: 40px;
            color: var(--text-secondary);
        }
    </style>
</head>
<body class="dark-mode">
    <button class="btn btn-secondary logout-btn" onclick="logout()">ë¡œê·¸ì•„ì›ƒ</button>

    <div class="admin-container">
        <div class="admin-header">
            <h1 class="admin-title">ğŸ‘¨â€ğŸ’¼ ê´€ë¦¬ì í˜ì´ì§€</h1>
            <p class="admin-subtitle">ì‚¬ìš©ì ê³„ì • ë° ì„¤ì • ê´€ë¦¬</p>
        </div>

        <!-- ì‹ ê·œ ì‚¬ìš©ì ìƒì„± -->
        <div class="admin-section">
            <h2 class="section-title">ì‹ ê·œ ì‚¬ìš©ì ìƒì„±</h2>
            <div class="create-user-form">
                <input
                    type="text"
                    id="new-username"
                    class="input-text"
                    placeholder="ì•„ì´ë””"
                >
                <input
                    type="password"
                    id="new-password"
                    class="input-text"
                    placeholder="ë¹„ë°€ë²ˆí˜¸"
                >
                <select id="new-role" class="select-input">
                    <option value="user">ì¼ë°˜ ì‚¬ìš©ì</option>
                    <option value="admin">ê´€ë¦¬ì</option>
                </select>
                <button class="btn btn-primary" onclick="createUser()">
                    âœ¨ ìƒì„±
                </button>
            </div>
        </div>

        <!-- ì‚¬ìš©ì ëª©ë¡ -->
        <div class="admin-section">
            <h2 class="section-title">ì‚¬ìš©ì ëª©ë¡</h2>
            <div id="users-list-container">
                <div class="loading">ğŸ“Š ì‚¬ìš©ì ëª©ë¡ì„ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</div>
            </div>
        </div>
    </div>

    <script>
        const token = localStorage.getItem('auth_token');
        const role = localStorage.getItem('role');

        // ê¶Œí•œ í™•ì¸
        if (!token || role !== 'admin') {
            alert('ê´€ë¦¬ì ê¶Œí•œì´ í•„ìš”í•©ë‹ˆë‹¤');
            window.location.href = '/login.html';
        }

        // í˜ì´ì§€ ë¡œë“œ ì‹œ ì‚¬ìš©ì ëª©ë¡ ë¡œë“œ
        loadUsers();

        async function createUser() {
            const username = document.getElementById('new-username').value.trim();
            const password = document.getElementById('new-password').value;
            const role = document.getElementById('new-role').value;

            if (!username || !password) {
                alert('ì•„ì´ë””ì™€ ë¹„ë°€ë²ˆí˜¸ë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”');
                return;
            }

            try {
                const response = await fetch('/api/admin/users', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${token}`
                    },
                    body: JSON.stringify({ username, password, role })
                });

                const data = await response.json();

                if (!response.ok) {
                    throw new Error(data.error || 'ì‚¬ìš©ì ìƒì„± ì‹¤íŒ¨');
                }

                alert('âœ… ì‚¬ìš©ìê°€ ìƒì„±ë˜ì—ˆìŠµë‹ˆë‹¤');

                // ì…ë ¥ í•„ë“œ ì´ˆê¸°í™”
                document.getElementById('new-username').value = '';
                document.getElementById('new-password').value = '';

                // ëª©ë¡ ìƒˆë¡œê³ ì¹¨
                loadUsers();

            } catch (error) {
                alert('âŒ ' + error.message);
            }
        }

        async function loadUsers() {
            try {
                const response = await fetch('/api/admin/users', {
                    headers: {
                        'Authorization': `Bearer ${token}`
                    }
                });

                const data = await response.json();

                if (!response.ok) {
                    throw new Error(data.error || 'ëª©ë¡ ë¡œë“œ ì‹¤íŒ¨');
                }

                renderUsers(data.users);

            } catch (error) {
                document.getElementById('users-list-container').innerHTML = `
                    <div class="empty-state">
                        âŒ ${error.message}
                    </div>
                `;
            }
        }

        function renderUsers(users) {
            if (!users || users.length === 0) {
                document.getElementById('users-list-container').innerHTML = `
                    <div class="empty-state">
                        ğŸ“­ ë“±ë¡ëœ ì‚¬ìš©ìê°€ ì—†ìŠµë‹ˆë‹¤
                    </div>
                `;
                return;
            }

            const tableHTML = `
                <table class="users-table">
                    <thead>
                        <tr>
                            <th>ì•„ì´ë””</th>
                            <th>ê¶Œí•œ</th>
                            <th>API íƒ€ì…</th>
                            <th>ì˜¤ëŠ˜ ì‚¬ìš©ëŸ‰</th>
                            <th>ìƒì„±ì¼</th>
                            <th>ì‘ì—…</th>
                        </tr>
                    </thead>
                    <tbody>
                        ${users.map(user => `
                            <tr>
                                <td><strong>${user.username}</strong></td>
                                <td>
                                    <span class="badge ${user.role === 'admin' ? 'badge-admin' : 'badge-user'}">
                                        ${user.role === 'admin' ? 'ğŸ‘‘ ê´€ë¦¬ì' : 'ğŸ‘¤ ì‚¬ìš©ì'}
                                    </span>
                                </td>
                                <td>${user.apiType || 'ë¯¸ì„¤ì •'}</td>
                                <td>${user.dailyQuota || 0} / 100</td>
                                <td>${new Date(user.createdAt).toLocaleDateString('ko-KR')}</td>
                                <td>
                                    ${user.username === localStorage.getItem('username')
                                        ? '<span style="color: var(--text-secondary);">í˜„ì¬ ê³„ì •</span>'
                                        : `<button class="btn-delete" onclick="deleteUser('${user.username}')">ì‚­ì œ</button>`
                                    }
                                </td>
                            </tr>
                        `).join('')}
                    </tbody>
                </table>
            `;

            document.getElementById('users-list-container').innerHTML = tableHTML;
        }

        async function deleteUser(username) {
            if (!confirm(`ì •ë§ "${username}" ê³„ì •ì„ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?`)) {
                return;
            }

            try {
                const response = await fetch(`/api/admin/users?username=${username}`, {
                    method: 'DELETE',
                    headers: {
                        'Authorization': `Bearer ${token}`
                    }
                });

                const data = await response.json();

                if (!response.ok) {
                    throw new Error(data.error || 'ì‚­ì œ ì‹¤íŒ¨');
                }

                alert('âœ… ì‚¬ìš©ìê°€ ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤');
                loadUsers();

            } catch (error) {
                alert('âŒ ' + error.message);
            }
        }

        function logout() {
            localStorage.removeItem('auth_token');
            localStorage.removeItem('username');
            localStorage.removeItem('role');
            window.location.href = '/login.html';
        }
    </script>
</body>
</html>
